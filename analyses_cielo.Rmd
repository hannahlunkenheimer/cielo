---
title: "cielo analyses"
author: "Hannah Lunkenheimer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set working directory
knitr::opts_knit$set(root.dir = '/Documents/Github/cielo')

# Libraries 
library(tidyverse)
library(here)
library(psych)
library(nFactors)
library(lme4)
library(nlme)
library(FactoMineR)
library(sem)
library(ggplot2)
library(dplyr)
library(lavaan) # for factor analysis 
library(performance) # for model performance
library(texreg)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(lattice)
library(readr)

```



```{r importing the data}
# importing the data
d_all <- read_csv("data/Cielo1_MergedFull_practice.csv")

# now let's view our data
View(d_all)

# some participant data needs to be thrown out completely according to the red rows in our CSV file, so let's remove those participants completely here (ID 129, 152, 175, and 277)
subset(d_all, id_num != "129" & id_num != "152" & id_num != "175" & id_num != "277")
# great, we've removed our 4 participants completely from our dataframe d_all and now have all of the participants we can use for analyses
```

```{r selecting practice items}

# here, we're creating a new dataframe for a subset of our data that we want to look at (the practice questions)
d_practice <- d_all %>% dplyr::select(practice_dogs, practice_veg, practice_swim)

# now let's view the subset of our full data set
View(d_practice)

```

```{r descriptives practice items}

# let's look at the means, SDs, min and max for our d_practice dataframe
describe(d_practice)

#when we want to get a general idea of the responses from the dataframe, we can use the head() function for a quick look (the tibble() fuction also works for this)
head(d_practice)

# here, we're telling R which order we want the responses to be in (levels) so that our figure matches our scale. you can specify any order you want here by using ""s and what the responses are exactly. for example, if we had written "really disagree", R would not have ordered that response bc of the capitalization sensitivity

d_practice$practice_dogs = factor(d_practice$practice_dogs, levels=c("Really Disagree", "Disagree", "Kind of Disagree", "Kind of Agree", "Agree", "Really Agree"))

# let's plot the descriptive statistics with a figure using the ggplot package in our library
dog_plot <- ggplot(d_practice, aes(practice_dogs)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Practice Question - Dogs") +
  theme_light()

# calling our figure
dog_plot

# nice!

#reordering the levels of the swim practice question
d_practice$practice_swim = factor(d_practice$practice_swim, levels=c("Really Disagree", "Disagree", "Kind of Disagree", "Kind of Agree", "Agree", "Really Agree"))

# making our ggplot
swim_plot <- ggplot(d_practice, aes(practice_swim)) +
  geom_bar(fill='purple') + 
  labs(x='Scale', y="Participants", title ="Practice Question - Swim") + 
  theme_light()

# calling our figure
swim_plot

################################
### IF YOU WANT TO PRACTICE! ###
################################

# try making your own descriptive figures from any of the variables we have access to in our cielo data. if you're having trouble remembering what the column names are, use the View() function 
```

```{r more descriptive stuff exists}

# here, we're creating a new dataframe for a subset of our data that we want to look at (the exist questions)
d_exist <- dplyr::select(d_all, exist_germs, exist_tooth, exist_vitamins, exist_merm, exist_elf, exist_fairy,
                         exist_soul, exist_god, exist_santa, exist_elf, contains("id_num"))

#viewing our new dataframe with our exist questions subset of data
View(d_exist)

existgerms_plot <- ggplot(d_exist, aes(exist_germs)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are germs real?") +
  theme_light()

existvit_plot <- ggplot(d_exist, aes(exist_vitamins)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are vitamins real?") +
  theme_light()

existmerm_plot <- ggplot(d_exist, aes(exist_merm)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are mermaids real?") +
  theme_light()

existelf_plot <- ggplot(d_exist, aes(exist_elf)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are elves real?") +
  theme_light()

existfairy_plot <- ggplot(d_exist, aes(exist_fairy)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are fairies real?") +
  theme_light()

existsoul_plot <- ggplot(d_exist, aes(exist_soul)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Are sould real?") +
  theme_light()

existgod_plot <- ggplot(d_exist, aes(exist_god)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Is God real?") +
  theme_light()

existsanta_plot <- ggplot(d_exist, aes(exist_santa)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Is Santa real?") +
  theme_light()

existtooth_plot <- ggplot(d_exist, aes(exist_tooth)) +
  geom_bar(fill='light blue') +
  labs(x='Scale', y="Participants", title ="Is the tooth fairy real?") +
  theme_light()

# calling our figures
existgerms_plot
existvit_plot
existmerm_plot
existelf_plot
existfairy_plot
existsoul_plot
existgod_plot 
existsanta_plot
existtooth_plot

# let's convert our data to tall format so we can include all of the same plots on the same figure
library(reshape2)
d_exist <- melt(d_exist, id.vars="id_num")

#let's view our tall data now
View(d_exist)

ggplot(d_exist,                                      # Grouped plot using ggplot2
  aes(x = value, y = variable, color = variable)) +
  geom_count(stat = "identity", position = "identity") +
  geom_jitter(size=.4, width = .3) +
  theme_light()

# hL will add a bar graph with these counts here bc don't like the previous figure ^

```
```{r exist bar figure}
# need to create a sum of counts? by piping check prev code

#1. next to each other
p1<-ggplot(d_exist,aes(x=factor(variable),y=count,fill=factor(value)), color=factor(value)) +
  stat_summary(fun.y=mean,position=position_dodge(),geom="bar")
p1

#2. stacked
p2<-ggplot(mtc,aes(x=factor(gear),y=wt,fill=factor(vs)), color=factor(vs)) +  
  stat_summary(fun.y=mean,position="stack",geom="bar")

#3. with facets
p3<-ggplot(mtc,aes(x=factor(gear),y=wt,fill=factor(vs)), color=factor(vs)) +  
  stat_summary(fun.y=mean, geom="bar") +
  facet_wrap(~vs)

grid.arrange(p1, p2, p3, nrow=1)

```


## Predictions and analyses in preregistration (and more)

Question: Age as continuous

## Confirmatory analyses:
1.	Children view God as less causally relevant with age, whereas belief in God remains stable. Positive effect of religious exposure and parent interventionist beliefs on children’s causally relevant God concepts. These will interact such that children from religious families will view God as increasingly causally relevant with age. Children who perceive less control in their lives will have a more causally relevant God concept.

### Effects of age, religiosity, and control on interventionist concepts

i.	Effects of age (and religiosity*) (and control**) on interventionist concepts - child choice (explicit concept) task

1.	Multinomial logistic regression
a.	Model with all 3 above (age, relig, control) + interactions = best fit model. Put all 3 parent variables into the model and take out if not predictive. Test for multicollinearity. If yes, then Principal Components Analysis.

```{r age intervention child choice reg}
#downloading libraries for multinomial reg
library(foreign)
library(nnet)



```

ii.	Effects of age (and religiosity*) (and control) on interventionist concepts – interview questions
1.	Could use linear regression if dv is sum of 4 questions. Best fit model (using AIC criterion etc)

```{r age intervention interview reg}


```

iii.	Effects of age, etc on “intervention frequency task” (Does God make..?). Would just sum number of yes responses as dv.
1.	Linear regression (+histogram of each question. Factor analysis to determine clusters)

```{r age intervention task fa}
# here is some of my old code on doing factor analysis

# we're selecting our subset of data and calling it to a new dataframe
d_practice_fa <- d_all %>% select(contains("practice_")) 

# if any recoding needs to be done, it can look like this
d_all1$PO5_abortion <- recode(d_all1$PO5_abortion, '1' = 7, '2'=6, '3'=5, '4'=4, '5'=3, '6'=2, '7'=1)
d_all1$PO6_sex <- recode(d_all1$PO6_sex, '1' = 7, '2'=6, '3'=5, '4'=4, '5'=3, '6'=2, '7'=1)

# Extract number of factors
ev <- eigen(cor(d_all1)) # get eigenvalues
ap <- parallel(subject=nrow(d_all1),var=ncol(d_all1),              rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)

## Exploratory Factor analysis, testing with 3 factors and 2 factors to start, using varimax rotation for all
fact3 <- factanal(d_all1, 3, rotation="varimax") 
print(fact, digits=2, cutoff=.3, sort=TRUE)

fact2 <- factanal(d_all1, 2, rotation="varimax") 
print(fact, digits=2, cutoff=.3, sort=TRUE)

# this is to see if 1 factor is fine, which we'd then do a principal components analysis if this was the best loading
#fact <- factanal(d_all, 1, rotation="varimax") # show improvement 5, 4, 3
#print(fact, digits=2, cutoff=.3, sort=TRUE)

# Reduce factors- we do this to see if taking out items makes the loadings more clear. regardless of the outcome we find, it's up to our discretion as researchers on whether or not to omit certain items from a set of questions based on rationale
# d_all <- d_all %>% select(- Epistemic_4) %>% select(- Epistemic_6) # Why? 
# fact <- factanal(d_all, 3, rotation="varimax")
# print(fact, digits=2, cutoff=.3, sort=TRUE) # Optimal model w/3 factors 

# here we're plotting our factors (3 and 2) to visually see where the items are loading
load <- fact3$loadings[,1:3]
plot(load,type="n") # set up plot
text(load,labels=names(d_all1),cex=.7) # add variable names

load <- fact2$loadings[,1:2]
plot(load,type="n") # set up plot
text(load,labels=names(d_all1),cex=.7) # add variable names

```

```{r age intervention task reg}


```

iv.	Effects of age on God real/pret (we can use kids who said pretend to get a general sense of God belief in our larger sample)
1.	Binomial logistic regression

```{r age god real reg}


```

v.	Effects of age on God certainty in our study sample
1.	Binomial logistic regression

```{r age god certainty reg}


```

### Exploratory analyses: Qualitative responses to interview questions. 
Also include here an analysis of what types of things kids think God does (intervention frequency task).

1.  Factor analysis on “Does God..?” (intervention frequency) task. Then analyze whether the factors differ and differ by age
	a. dv is continuous so repeated measures ANOVA with age group as iv (I don’t know how to do repeated measures if age is continuous – is there a repeated measure regression?)
	b. add parent/relig questions to this?
	
```{r intervention freq FA}


```

2. Number and percent of each explanation type to assess whether we need to collapse categories – probably around 5 is ideal and we have more than that. Then collapse if we need to and calculate percentage of children’s responses in each category as a function of age and parent concepts/religiosity. Make graphs of these. 
	a. logistic regression to assess effects of category type and interactions with age and religiosity (used this in W&C) – is dv proportion or number?
	b. need to compute reliability (Cohen’s Kappa in SPSS)
	
```{r log reg}


```
